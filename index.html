<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LibPro Cloud v3.6 - Seboterapia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; animation: fadeIn 0.2s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .active-tab { color: #4f46e5; background: #eef2ff; border-radius: 16px; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-6">

	<header class="glass sticky top-0 z-40 border-b border-slate-200">
	    <div class="px-6 py-4 flex justify-between items-center">
	        <div>
	            <h1 class="text-xl font-extrabold tracking-tight text-indigo-600">LibPro Cloud</h1>
	            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none">M√≥dulo Seboterapia v3.6</p>
	        </div>
	        <div id="spinner" class="hidden animate-spin w-5 h-5 border-2 border-indigo-600 border-t-transparent rounded-full"></div>
	    </div>
	
	    <nav class="flex justify-around items-center px-2 pb-2">
	        <button onclick="switchTab('cadastro', this)" class="flex flex-col items-center gap-1 p-2 active-tab transition-all">
	            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M12 4v16m8-8H4" /></svg>
	            <span class="text-[9px] font-black uppercase">Novo</span>
	        </button>
	        <button onclick="switchTab('acervo', this)" class="flex flex-col items-center gap-1 p-2 text-slate-400 transition-all">
	            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
	            <span class="text-[9px] font-black uppercase">Lista</span>
	        </button>
	        <button onclick="switchTab('relatorios', this)" class="flex flex-col items-center gap-1 p-2 text-slate-400 transition-all">
	            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
	            <span class="text-[9px] font-black uppercase">Relat√≥rios</span>
	        </button>
	        <button onclick="switchTab('config', this)" class="flex flex-col items-center gap-1 p-2 text-slate-400 transition-all">
	            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /></svg>
	            <span class="text-[9px] font-black uppercase">Ajustes</span>
	        </button>
	    </nav>
	</header>

    <main class="max-w-2xl mx-auto px-4 pt-6">
        
        <section id="cadastro" class="tab-content active space-y-4">
            
            <div class="flex gap-2">
                <input type="text" id="buscaManual" placeholder="ISBN ou c√≥digo de barras..." class="flex-1 bg-white p-4 rounded-2xl border border-slate-200 outline-none shadow-sm text-sm">
                
                <button type="button" onclick="window.buscarLivro()" class="bg-indigo-600 text-white p-4 rounded-2xl shadow-lg active:scale-95 transition-all" title="Pesquisar">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </button>
                
                <button onclick="abrirScanner()" class="bg-slate-800 text-white p-4 rounded-2xl shadow-lg active:scale-95 transition-all" title="Escanear">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                </button>
            </div>

            <form id="formLivro" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 space-y-5">
                <input type="hidden" id="edit_id">
                
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex flex-col items-center gap-2">
                        <div class="relative">
                            <div class="w-32 h-44 bg-slate-100 rounded-2xl overflow-hidden flex flex-col items-center justify-center border-2 border-dashed border-slate-200">
                                <img id="preview" src="" class="w-full h-full object-cover z-10 hidden">
                                <div id="placeholder-icon" class="flex flex-col items-center text-slate-300">
                                    <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                                </div>
                            </div>
                            <button type="button" onclick="abrirCameraDireta()" class="absolute -bottom-2 -right-2 bg-indigo-600 text-white p-2.5 rounded-full shadow-lg z-20 active:scale-90"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 13a3 3 0 11-6 0 3 3 0 016 0zM3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /></svg></button>
                        </div>
                        <button type="button" onclick="document.getElementById('fileInput').click()" class="text-[10px] font-extrabold text-slate-500 bg-slate-100 px-4 py-2 rounded-xl hover:bg-slate-200 transition-all uppercase">Arquivo</button>
                        <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="previewArquivo(this)">
                    </div>

                    <div class="flex-1 space-y-4">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase">T√≠tulo do Livro</label>
                            <input type="text" id="titulo" required class="w-full text-lg font-bold border-b-2 border-slate-100 py-1 outline-none focus:border-indigo-500 bg-transparent">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase">Autor / Escritor</label>
                            <input type="text" id="autor" class="w-full text-md border-b-2 border-slate-100 py-1 outline-none focus:border-indigo-500 bg-transparent">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase">ISBN</label>
                                <input type="text" id="isbn" class="w-full text-sm border-b border-slate-200 py-1 outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase">P√°ginas</label>
                                <input type="number" id="paginas" class="w-full text-sm border-b border-slate-200 py-1 outline-none">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pt-2">
                    <div class="md:col-span-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase">Editora</label>
                        <input type="text" id="editora" class="w-full text-sm border-b border-slate-200 py-1 outline-none">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="text-[10px] font-black text-indigo-600 uppercase">SKU / Identificador</label>
                        <div class="flex gap-2 items-end">
                            <input type="text" id="sku" class="flex-1 text-sm border-b border-indigo-200 py-1 outline-none font-bold text-indigo-700">
                            <button type="button" onclick="window.gerarSkuAuto()" class="p-2 bg-slate-100 text-slate-500 rounded-xl hover:bg-slate-200 active:scale-95 transition-all" title="Gerar SKU">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                            </button>
                        </div>
                    </div>

                    <div class="md:col-span-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase">Categoria</label>
                        <select id="select_categoria" class="w-full text-xs font-bold py-2.5 bg-slate-50 rounded-xl px-3 mt-1 outline-none border border-transparent focus:border-indigo-200"></select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase">Conserva√ß√£o</label>
                        <select id="select_estado" class="w-full text-xs font-bold py-2.5 bg-slate-50 rounded-xl px-3 mt-1 outline-none border border-transparent focus:border-indigo-200"></select>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase">Observa√ß√µes do Exemplar</label>
                    <textarea id="observacao" rows="3" class="w-full text-sm border border-slate-100 py-2 outline-none bg-slate-50 rounded-2xl px-3 mt-1 focus:bg-white focus:border-indigo-200 transition-all" placeholder="Detalhes como dedicat√≥rias, amarelamento, grifos..."></textarea>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="window.limparCampos()" class="p-4 bg-slate-100 text-slate-500 rounded-2xl hover:bg-slate-200 active:scale-95 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                    </button>
                    <input type="hidden" id="url_foto">
                    <button type="submit" id="btnSalvar" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-extrabold shadow-lg active:scale-95 hover:bg-indigo-700 transition-all tracking-widest">SALVAR NO ACERVO</button>
                </div>
            </form>
        </section>

        <section id="acervo" class="tab-content space-y-4">
            <div class="flex justify-between items-end">
                <h2 class="text-xl font-black text-slate-800 uppercase tracking-tighter">Meu Acervo</h2>
                <span id="contador" class="text-[10px] font-bold bg-indigo-100 px-3 py-1 rounded-full text-indigo-600">...</span>
            </div>
            <input type="text" id="filtro" onkeyup="window.filtrarAcervoLocal()" placeholder="Buscar por t√≠tulo, autor ou SKU..." class="w-full bg-white p-4 rounded-2xl border border-slate-200 outline-none shadow-sm text-sm focus:border-indigo-300 transition-all">
            <div id="lista_acervo" class="grid grid-cols-1 gap-3"></div>
        </section>

        <section id="relatorios" class="tab-content space-y-6">
            <h2 class="text-xl font-black text-slate-800 uppercase tracking-tighter">Exportar Dados</h2>
            <div class="bg-white p-6 rounded-3xl border border-slate-200 space-y-4 shadow-sm">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase">De:</label>
                        <input type="date" id="rel_data_inicio" class="w-full bg-slate-50 p-3 rounded-xl text-xs outline-none border border-slate-100">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase">At√©:</label>
                        <input type="date" id="rel_data_fim" class="w-full bg-slate-50 p-3 rounded-xl text-xs outline-none border border-slate-100">
                    </div>
                </div>
                <div class="space-y-3">
                    <select id="rel_filtro_categoria" class="w-full bg-slate-50 p-3 rounded-xl text-xs outline-none border border-slate-100 font-bold"><option value="">Todas Categorias</option></select>
                    <select id="rel_filtro_editora" class="w-full bg-slate-50 p-3 rounded-xl text-xs outline-none border border-slate-100 font-bold"><option value="">Todas Editoras</option></select>
                    <select id="rel_filtro_conservacao" class="w-full bg-slate-50 p-3 rounded-xl text-xs outline-none border border-slate-100 font-bold"><option value="">Todas Conserva√ß√µes</option></select>
                </div>
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button onclick="window.gerarRelatorio('excel')" class="bg-emerald-600 text-white p-4 rounded-2xl font-bold text-xs uppercase shadow-md active:scale-95">Planilha Excel</button>
                    <button onclick="window.gerarRelatorio('pdf')" class="bg-rose-600 text-white p-4 rounded-2xl font-bold text-xs uppercase shadow-md active:scale-95">Documento PDF</button>
                </div>
            </div>
            <div id="dashboard" class="grid grid-cols-2 gap-3">
                <div class="bg-indigo-600 p-5 rounded-3xl text-white shadow-lg shadow-indigo-200">
                    <p class="text-[10px] font-bold uppercase opacity-80">Total Itens</p>
                    <h3 id="dash_total" class="text-3xl font-black">0</h3>
                </div>
                <div class="bg-white p-5 rounded-3xl border border-slate-200">
                    <p class="text-[10px] font-black text-slate-400 uppercase">G√™neros</p>
                    <h3 id="dash_cats" class="text-3xl font-black text-indigo-600">0</h3>
                </div>
            </div>
            <div class="bg-white p-5 rounded-3xl border border-slate-200"><div id="dash_lista_categorias" class="space-y-3 text-xs"></div></div>
        </section>

        <section id="config" class="tab-content space-y-6">
            <h2 class="text-xl font-black text-slate-800 uppercase tracking-tighter">Configura√ß√µes</h2>
            
            <div class="bg-white p-6 rounded-3xl border border-slate-200 space-y-4">
                <h3 class="text-[10px] font-black text-indigo-600 uppercase">Gerenciar Categorias</h3>
                <div class="flex gap-2"><input type="text" id="input_cat" class="flex-1 bg-slate-50 p-3 rounded-xl outline-none text-sm border"><button onclick="window.adicionarAuxCloud('categorias')" class="bg-indigo-600 text-white px-6 rounded-xl font-bold">+</button></div>
                <div id="list_cat" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="bg-white p-6 rounded-3xl border border-slate-200 space-y-4">
                <h3 class="text-[10px] font-black text-indigo-600 uppercase">Estados de Conserva√ß√£o</h3>
                <div class="flex gap-2"><input type="text" id="input_est" class="flex-1 bg-slate-50 p-3 rounded-xl outline-none text-sm border"><button onclick="window.adicionarAuxCloud('estados')" class="bg-indigo-600 text-white px-6 rounded-xl font-bold">+</button></div>
                <div id="list_est" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="bg-white p-6 rounded-3xl border border-slate-200 space-y-4 shadow-sm">
                <h3 class="text-[10px] font-black text-indigo-600 uppercase">Seguran√ßa e Backup</h3>
                <p class="text-[10px] text-slate-400 font-bold uppercase">Exporte seu acervo ou restaure de um arquivo JSON.</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="window.exportarJSON()" class="bg-slate-800 text-white p-3 rounded-xl font-bold text-[10px] uppercase shadow-md active:scale-95 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Exportar JSON
                    </button>
                    <label class="bg-amber-500 text-white p-3 rounded-xl font-bold text-[10px] uppercase shadow-md active:scale-95 flex items-center justify-center gap-2 cursor-pointer text-center">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                        Importar JSON
                        <input type="file" id="import_json" class="hidden" accept=".json" onchange="window.importarJSON(this)">
                    </label>
                </div>
            </div>
        </section>
    </main>

    <div id="modalScanner" class="hidden fixed inset-0 z-[60] bg-slate-900 flex flex-col p-6"><div class="flex justify-between items-center text-white mb-6"><h3 class="font-bold uppercase tracking-widest text-xs">Scanner de ISBN</h3><button onclick="fecharScanner()" class="p-3 bg-white/10 rounded-full">‚úï</button></div><div id="reader" class="overflow-hidden rounded-3xl bg-black flex-1 shadow-2xl"></div></div>
    <div id="modalCamera" class="hidden fixed inset-0 z-[60] bg-black flex flex-col p-6"><video id="videoElement" class="w-full h-full object-cover rounded-3xl shadow-2xl" autoplay playsinline></video><div class="absolute bottom-12 left-0 right-0 flex justify-center gap-8"><button onclick="fecharCamera()" class="bg-white/10 p-5 rounded-full text-white backdrop-blur-md">‚úï</button><button onclick="capturarFoto()" class="bg-white p-6 rounded-full text-black scale-125 shadow-xl">üì∏</button></div></div>
    <canvas id="canvasElement" class="hidden"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot, setDoc, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // ATEN√á√ÉO: Substitua os placeholders abaixo pelas suas chaves reais do Firebase
		const firebaseConfig = {
		  apiKey: "process.env.FIREBASE_API_KEY",
		  authDomain: "process.env.FIREBASE_AUTH_DOMAIN",
		  projectId: "process.env.FIREBASE_PROJECT_ID",
		  storageBucket: "process.env.FIREBASE_STORAGE_BUCKET",
		  messagingSenderId: "process.env.FIREBASE_MESSAGING_SENDER_ID",
		  appId: "process.env.FIREBASE_APP_ID",
		  measurementId: "process.env.FIREBASE_MEASUREMENT_ID"
		};

        const app = initializeApp(firebaseConfig);
        const db_cloud = getFirestore(app);
        const storage = getStorage(app);

        let acervoCache = [];
        let auxiliares = { categorias: [], estados: [] };

        // SKU AUTOM√ÅTICO
        window.gerarSkuAuto = () => {
            const ag = new Date();
            const sku = `L${ag.toISOString().slice(2, 10).replace(/-/g, '')}-${ag.getHours().toString().padStart(2, '0')}${ag.getMinutes().toString().padStart(2, '0')}`;
            document.getElementById('sku').value = sku;
        };

        // BUSCA ISBN
        window.buscarLivro = async (val = null) => {
            const t = val || document.getElementById('buscaManual').value;
            if(!t) return;
            document.getElementById('spinner').classList.remove('hidden');
            try {
                const res = await fetch(`https://brasilapi.com.br/api/isbn/v1/${t}`);
                if(res.ok) {
                    const d = await res.json();
                    document.getElementById('titulo').value = d.title || '';
                    document.getElementById('autor').value = d.authors?.join(', ') || '';
                    document.getElementById('editora').value = d.publisher || '';
                    document.getElementById('paginas').value = d.page_count || '';
                    document.getElementById('isbn').value = d.isbn || t;
                    window.setCapa(`https://covers.openlibrary.org/b/isbn/${t}-L.jpg`);
                }
            } catch(e) { console.error(e); }
            finally { document.getElementById('spinner').classList.add('hidden'); }
        };

        window.setCapa = (u) => {
            const i = document.getElementById('preview'), ph = document.getElementById('placeholder-icon'), inp = document.getElementById('url_foto');
            i.src = u; i.classList.remove('hidden'); ph.classList.add('hidden'); inp.value = u;
        };

        // REAL-TIME SYNC
        onSnapshot(query(collection(db_cloud, "livros"), orderBy("timestamp", "desc")), (snap) => {
            acervoCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderizarUI(acervoCache);
            atualizarDashboard();
            atualizarSelectsFiltro();
        });

        function atualizarDashboard() {
            document.getElementById('dash_total').innerText = acervoCache.length;
            const ct = [...new Set(acervoCache.map(l => l.categoria))].filter(c => c);
            document.getElementById('dash_cats').innerText = ct.length;
            const cont = {};
            acervoCache.forEach(l => cont[l.categoria] = (cont[l.categoria] || 0) + 1);
            document.getElementById('dash_lista_categorias').innerHTML = Object.entries(cont).sort((a,b)=>b[1]-a[1]).map(([c, q]) => `<div class="flex justify-between border-b border-slate-50 pb-1"><span>${c}</span><span class="font-black text-indigo-600">${q}</span></div>`).join('') || 'Sem dados.';
        }

        function atualizarSelectsFiltro() {
            const sc = document.getElementById('rel_filtro_categoria'), se = document.getElementById('rel_filtro_editora'), so = document.getElementById('rel_filtro_conservacao');
            if(!sc || !se || !so) return;
            const vc = sc.value, ve = se.value, vo = so.value;
            // A renderiza√ß√£o dos options das categorias √© feita no renderAuxUI, aqui apenas editoras
            const eds = [...new Set(acervoCache.map(l => l.editora).filter(e => e))].sort();
            se.innerHTML = '<option value="">Editoras</option>'; eds.forEach(e => se.innerHTML += `<option value="${e}">${e}</option>`);
            // Os valores s√£o restaurados ou mantidos pelo renderAuxUI
        }

        // RELAT√ìRIOS
        window.gerarRelatorio = (tipo) => {
            const di = document.getElementById('rel_data_inicio').value, df = document.getElementById('rel_data_fim').value;
            const cf = document.getElementById('rel_filtro_categoria').value, ef = document.getElementById('rel_filtro_editora').value, os = document.getElementById('rel_filtro_conservacao').value;
            let filt = acervoCache;
            if (di || df) {
                if (di) filt = filt.filter(l => l.timestamp?.toDate() >= new Date(di));
                if (df) { const d = new Date(df); d.setHours(23,59,59); filt = filt.filter(l => l.timestamp?.toDate() <= d); }
            }
            if (cf) filt = filt.filter(l => l.categoria === cf);
            if (ef) filt = filt.filter(l => l.editora === ef);
            if (os) filt = filt.filter(l => l.estado === os);
            if (filt.length === 0) return alert("Nenhum item!");
            tipo === 'excel' ? exportarXLSX(filt) : exportarPDF(filt);
        };

        // --- ATUALIZADO: Exporta√ß√£o Excel com novas colunas ---
        function exportarXLSX(dados) {
            const f = dados.map(l => ({ 
                SKU: l.sku, 
                T√≠tulo: l.titulo, 
                Autor: l.autor, 
                ISBN: l.isbn, 
                Editora: l.editora, 
                Categoria: l.categoria, 
                Estado: l.estado, 
                Observa√ß√£o: l.observacao || "", 
                Data: l.timestamp?.toDate().toLocaleDateString('pt-BR'),
                // Colunas adicionadas conforme solicitado
                P√°ginas: l.paginas || "",
                "Link Imagem": l.foto || ""
            }));
            const ws = XLSX.utils.json_to_sheet(f); const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "LibPro"); XLSX.writeFile(wb, `Acervo_${Date.now()}.xlsx`);
        }

        function exportarPDF(dados) {
            const { jsPDF } = window.jspdf; const docP = new jsPDF('l', 'mm', 'a4');
            const cols = ['SKU', 'T√≠tulo', 'Editora', 'Cat', 'Estado', 'Data'];
            const lines = dados.map(l => [l.sku, l.titulo, l.editora, l.categoria, l.estado, l.timestamp?.toDate().toLocaleDateString('pt-BR')]);
            docP.text(`Relat√≥rio LibPro - ${dados.length} itens`, 14, 15);
            docP.autoTable({ head: [cols], body: lines, startY: 20, theme: 'striped' });
            docP.save(`Acervo_${Date.now()}.pdf`);
        }

        // FUN√á√ïES DE BACKUP JSON
        window.exportarJSON = () => {
            if (acervoCache.length === 0) return alert("O acervo est√° vazio.");
            const exportData = acervoCache.map(({id, ...rest}) => rest); // Remove ID do Firebase
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `LibPro_Backup_${new Date().toISOString().slice(0,10)}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        window.importarJSON = async (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const dados = JSON.parse(e.target.result);
                    if (!Array.isArray(dados)) throw new Error("Formato inv√°lido.");
                    if (!confirm(`Deseja importar ${dados.length} itens? SKUs duplicados ser√£o ignorados.`)) return;

                    document.getElementById('spinner').classList.remove('hidden');
                    let addCount = 0, skipCount = 0;
                    const skusExistentes = new Set(acervoCache.map(l => l.sku).filter(s => s));

                    for (const item of dados) {
                        if (item.sku && skusExistentes.has(item.sku)) {
                            skipCount++;
                            continue;
                        }
                        const finalData = { ...item, timestamp: Timestamp.now() };
                        await addDoc(collection(db_cloud, "livros"), finalData);
                        addCount++;
                    }
                    alert(`Importa√ß√£o conclu√≠da!\n‚úÖ ${addCount} itens adicionados.\n‚ö†Ô∏è ${skipCount} duplicados ignorados.`);
                    input.value = "";
                } catch (err) {
                    alert("Erro ao processar arquivo. Verifique se √© um backup JSON v√°lido.");
                } finally {
                    document.getElementById('spinner').classList.add('hidden');
                }
            };
            reader.readAsText(file);
        };

        /* // SALVAMENTO
        document.getElementById('formLivro').onsubmit = async (e) => {
            e.preventDefault(); document.getElementById('spinner').classList.remove('hidden');
            try {
                const idEd = document.getElementById('edit_id').value, fotoR = document.getElementById('url_foto').value;
                let urlF = fotoR;
                if(fotoR && fotoR.startsWith('data:image')) {
                    const sRef = ref(storage, `capas/${Date.now()}.jpg`);
                    await uploadString(sRef, fotoR, 'data_url'); urlF = await getDownloadURL(sRef);
                }
                const d = {
                    titulo: document.getElementById('titulo').value, autor: document.getElementById('autor').value,
                    isbn: document.getElementById('isbn').value, paginas: document.getElementById('paginas').value,
                    editora: document.getElementById('editora').value, sku: document.getElementById('sku').value,
                    categoria: document.getElementById('select_categoria').value, estado: document.getElementById('select_estado').value,
                    observacao: document.getElementById('observacao').value, foto: urlF, timestamp: Timestamp.now()
                };
                if(idEd) await updateDoc(doc(db_cloud, "livros", idEd), d);
                else await addDoc(collection(db_cloud, "livros"), d);
                window.limparCampos(); alert("Salvo no Cloud!");
            } catch(err) { alert("Erro ao sincronizar."); }
            finally { document.getElementById('spinner').classList.add('hidden'); }
        }; */

		// SALVAMENTO ATUALIZADO
        document.getElementById('formLivro').onsubmit = async (e) => {
            e.preventDefault(); 
            document.getElementById('spinner').classList.remove('hidden');
            
            try {
                // 1. VERIFICA√á√ÉO DE SKU: Se estiver vazio, gera autom√°tico agora
                const skuInput = document.getElementById('sku');
                if (!skuInput.value.trim()) {
                    const ag = new Date();
                    // Gera formato LYYMMDD-HHMM
                    const skuGerado = `L${ag.toISOString().slice(2, 10).replace(/-/g, '')}-${ag.getHours().toString().padStart(2, '0')}${ag.getMinutes().toString().padStart(2, '0')}`;
                    skuInput.value = skuGerado;
                }

                const idEd = document.getElementById('edit_id').value;
                const fotoR = document.getElementById('url_foto').value;
                let urlF = fotoR;

                // 2. UPLOAD DA IMAGEM (Usando o SKU garantido acima)
                if(fotoR && fotoR.startsWith('data:image')) {
                    // Sanitiza o SKU para nome de arquivo (remove barras, etc)
                    const skuNome = skuInput.value.replace(/[\/\\:*?"<>|]/g, '-');
                    const sRef = ref(storage, `capas/${skuNome}.jpg`);
                    await uploadString(sRef, fotoR, 'data_url'); 
                    urlF = await getDownloadURL(sRef);
                }

                // 3. PREPARA√á√ÉO DOS DADOS
                const d = {
                    titulo: document.getElementById('titulo').value, 
                    autor: document.getElementById('autor').value,
                    isbn: document.getElementById('isbn').value, 
                    paginas: document.getElementById('paginas').value,
                    editora: document.getElementById('editora').value, 
                    sku: skuInput.value, // Usa o valor do input (seja o digitado ou o gerado auto)
                    categoria: document.getElementById('select_categoria').value, 
                    estado: document.getElementById('select_estado').value,
                    observacao: document.getElementById('observacao').value, 
                    foto: urlF, 
                    timestamp: Timestamp.now()
                };

                // 4. SALVAR NO FIRESTORE
                if(idEd) await updateDoc(doc(db_cloud, "livros", idEd), d);
                else await addDoc(collection(db_cloud, "livros"), d);
                
                window.limparCampos(); 
                alert("Salvo no Cloud com sucesso!");
            } catch(err) { 
                console.error(err);
                alert("Erro ao sincronizar: " + err.message); 
            } finally { 
                document.getElementById('spinner').classList.add('hidden'); 
            }
        };

        window.limparCampos = () => {
            document.getElementById('formLivro').reset(); document.getElementById('buscaManual').value = '';
            document.getElementById('edit_id').value = ''; document.getElementById('preview').classList.add('hidden');
            document.getElementById('placeholder-icon').classList.remove('hidden'); document.getElementById('url_foto').value = '';
            document.getElementById('btnSalvar').innerText = "SALVAR NO ACERVO"; renderizarUI(acervoCache);
        };

        window.editarLivro = (id) => {
            const l = acervoCache.find(x => x.id === id); switchTab('cadastro', document.querySelector('nav button:first-child'));
            document.getElementById('edit_id').value = l.id; document.getElementById('titulo').value = l.titulo;
            document.getElementById('autor').value = l.autor; document.getElementById('isbn').value = l.isbn;
            document.getElementById('editora').value = l.editora; document.getElementById('paginas').value = l.paginas || '';
            document.getElementById('sku').value = l.sku; document.getElementById('select_categoria').value = l.categoria;
            document.getElementById('select_estado').value = l.estado; document.getElementById('observacao').value = l.observacao || '';
            document.getElementById('btnSalvar').innerText = "ATUALIZAR LIVRO"; if(l.foto) window.setCapa(l.foto);
        };

        window.removerLivro = async (id) => { if(confirm("Excluir item definitivamente?")) await deleteDoc(doc(db_cloud, "livros", id)); };

        async function carregarAuxiliares() {
            const docS = await getDoc(doc(db_cloud, "config", "auxiliares"));
            auxiliares = docS.exists() ? docS.data() : { categorias: ["Fic√ß√£o"], estados: ["Bom"] };
            renderAuxUI();
        }

        window.adicionarAuxCloud = async (tipo) => {
            const inp = document.getElementById(tipo === 'categorias' ? 'input_cat' : 'input_est');
            if(!inp.value) return; if(!auxiliares[tipo]) auxiliares[tipo] = []; auxiliares[tipo].push(inp.value);
            await setDoc(doc(db_cloud, "config", "auxiliares"), auxiliares); inp.value = ''; carregarAuxiliares();
        };

        // --- NOVO: Fun√ß√£o para excluir categorias ou estados ---
        window.removerAuxCloud = async (tipo, valor) => {
            if(!confirm(`Deseja excluir "${valor}" das op√ß√µes de ${tipo}?`)) return;
            auxiliares[tipo] = auxiliares[tipo].filter(item => item !== valor);
            await setDoc(doc(db_cloud, "config", "auxiliares"), auxiliares);
            carregarAuxiliares();
        };

        // --- ATUALIZADO: Renderiza√ß√£o da UI de configura√ß√µes com bot√£o de excluir ---
        function renderAuxUI() {
            const u = (arr, lid, sid, tipo) => {
                const l = document.getElementById(lid), s = document.getElementById(sid);
                if(!l || !s) return;
                l.innerHTML = ''; s.innerHTML = ''; 
                (arr || []).forEach(it => {
                    // Bot√£o de remover adicionado ao lado do texto
                    l.innerHTML += `
                        <div class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-xl text-[10px] font-black uppercase border border-indigo-100 flex items-center gap-2 transition-all hover:bg-red-50 hover:border-red-100 hover:text-red-600 group">
                            <span>${it}</span>
                            <button onclick="window.removerAuxCloud('${tipo}', '${it}')" class="text-indigo-300 group-hover:text-red-500 font-bold px-1 hover:scale-125 transition-transform" title="Excluir">√ó</button>
                        </div>`;
                    s.innerHTML += `<option value="${it}">${it}</option>`;
                });
            };
            u(auxiliares.categorias, 'list_cat', 'select_categoria', 'categorias');
            u(auxiliares.estados, 'list_est', 'select_estado', 'estados');
            
            // Atualiza tamb√©m os selects de filtro da aba de Relat√≥rios
            const sc = document.getElementById('rel_filtro_categoria'), so = document.getElementById('rel_filtro_conservacao');
            const vc = sc.value, vo = so.value; // Tenta preservar a sele√ß√£o
            sc.innerHTML = '<option value="">Categorias</option>'; auxiliares.categorias.forEach(c => sc.innerHTML += `<option value="${c}">${c}</option>`);
            so.innerHTML = '<option value="">Conserva√ß√£o</option>'; auxiliares.estados.forEach(e => so.innerHTML += `<option value="${e}">${e}</option>`);
            sc.value = vc; so.value = vo;
        }

		function renderizarUI(dados) {
		    const c = document.getElementById('lista_acervo'); 
		    if(!c) return;
		    c.innerHTML = '';
		    document.getElementById('contador').innerText = `${dados.length} ITENS`;
		    
		    dados.forEach(l => {
		        c.innerHTML += `
		            <div class="bg-white p-4 rounded-3xl flex items-center gap-4 border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
		                <div class="w-16 h-20 bg-slate-50 rounded-xl overflow-hidden flex-shrink-0 flex items-center justify-center border border-slate-100">
		                    ${l.foto ? `<img src="${l.foto}" class="w-full h-full object-cover">` : 'üìö'}
		                </div>
		                <div class="flex-1 min-w-0">
		                    <h4 class="text-sm font-black text-slate-800 leading-tight">${l.titulo}</h4>
		                    <p class="text-[10px] text-slate-400 font-bold uppercase truncate mt-0.5">${l.autor}</p>
		                    <div class="mt-2 flex flex-wrap gap-2">
		                        <span class="text-[8px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-md font-black uppercase">${l.categoria}</span>
		                        <span class="text-[8px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-md font-black uppercase">${l.sku}</span>
		                    </div>
		                </div>
		                <div class="flex items-center gap-1">
		                    <button onclick="window.editarLivro('${l.id}')" class="p-2 text-indigo-400 hover:bg-indigo-50 rounded-full transition-colors text-lg">‚úé</button>
		                    <button onclick="window.removerLivro('${l.id}')" class="p-2 text-rose-200 hover:text-rose-500 transition-colors text-lg">‚úñ</button>
		                </div>
		            </div>`;
		    });
		}

        window.filtrarAcervoLocal = () => {
            const t = document.getElementById('filtro').value.toLowerCase();
            const f = acervoCache.filter(l => l.titulo.toLowerCase().includes(t) || l.autor.toLowerCase().includes(t) || l.sku.toLowerCase().includes(t));
            renderizarUI(f);
        };
        carregarAuxiliares();
    </script>

    <script>
        function switchTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-tab', 'text-slate-400'));
            document.getElementById(id).classList.add('active'); el.classList.add('active-tab');
        }
        let sc;
        function abrirScanner() {
            document.getElementById('modalScanner').classList.remove('hidden');
            sc = new Html5Qrcode("reader");
            sc.start({ facingMode: "environment" }, { fps: 20, qrbox: { width: 300, height: 150 }, aspectRatio: 1.0 }, t => {
                fecharScanner(); document.getElementById('buscaManual').value = t; window.buscarLivro(t);
            });
        }
        function fecharScanner() { if(sc) sc.stop(); document.getElementById('modalScanner').classList.add('hidden'); }
        async function abrirCameraDireta() {
            document.getElementById('modalCamera').classList.remove('hidden');
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            document.getElementById('videoElement').srcObject = stream; window.cStream = stream;
        }
        function fecharCamera() { if(window.cStream) window.cStream.getTracks().forEach(t => t.stop()); document.getElementById('modalCamera').classList.add('hidden'); }
        function capturarFoto() {
            const v = document.getElementById('videoElement'), c = document.getElementById('canvasElement');
            c.width = v.videoWidth; c.height = v.videoHeight;
            c.getContext('2d').drawImage(v, 0, 0); window.setCapa(c.toDataURL('image/jpeg', 0.8)); fecharCamera();
        }
        function previewArquivo(i) { if(i.files[0]) { const r = new FileReader(); r.onload = e => window.setCapa(e.target.result); r.readAsDataURL(i.files[0]); } }
    </script>
</body>
</html>
